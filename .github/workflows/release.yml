name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to release (for example v0.1.0)"
        required: true
        type: string

permissions:
  contents: write

jobs:
  build-binaries:
    name: Build binary (${{ matrix.os_name }}-${{ matrix.arch_name }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: ubuntu-latest
            os_name: linux
            arch_name: x64
            binary_ext: ""
          - runner: macos-14
            os_name: darwin
            arch_name: arm64
            binary_ext: ""
          - runner: windows-latest
            os_name: windows
            arch_name: x64
            binary_ext: ".exe"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag || github.ref }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build native binary
        run: bun run build:binary

      - name: Normalize binary filename
        run: |
          bun -e "
          import { existsSync, renameSync, rmSync } from 'node:fs';
          import { join } from 'node:path';
          const sourceCandidates = ['dist/decant.exe', 'dist/decant'];
          const source = sourceCandidates.find((file) => existsSync(file));
          if (!source) {
            throw new Error('Built binary not found in dist/.');
          }
          const osName = process.env.DECANT_OS_NAME;
          const archName = process.env.DECANT_ARCH_NAME;
          const ext = process.env.DECANT_BINARY_EXT ?? (source.endsWith('.exe') ? '.exe' : '');
          if (!osName || !archName) {
            throw new Error('Missing target platform metadata for artifact rename.');
          }
          const target = join('dist', 'decant-' + osName + '-' + archName + ext);
          if (existsSync(target)) {
            rmSync(target);
          }
          renameSync(source, target);
          console.log('Prepared artifact:', target);
          "
        env:
          DECANT_OS_NAME: ${{ matrix.os_name }}
          DECANT_ARCH_NAME: ${{ matrix.arch_name }}
          DECANT_BINARY_EXT: ${{ matrix.binary_ext }}

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: binaries-${{ matrix.os_name }}-${{ matrix.arch_name }}
          path: dist/decant-*
          if-no-files-found: error

  publish-release:
    name: Publish GitHub release
    needs: build-binaries
    runs-on: ubuntu-latest

    steps:
      - name: Download built binaries
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts
          merge-multiple: true

      - name: Generate checksums
        run: |
          cd release-artifacts
          shasum -a 256 * > checksums.txt

      - name: Checkout for changelog
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag || github.ref }}
          sparse-checkout: CHANGELOG.md
          sparse-checkout-cone-mode: false
          path: changelog-src

      - name: Extract release notes from changelog
        id: notes
        run: |
          TAG="${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag || github.ref_name }}"
          VERSION="${TAG#v}"
          # Extract the section for this version (between its heading and the next version heading)
          NOTES=$(awk "/^## \\[${VERSION}\\]/{found=1; next} /^## \\[/{if(found) exit} found{print}" changelog-src/CHANGELOG.md)
          # Write to file to preserve formatting
          echo "$NOTES" > release-notes.md

      - name: Publish release assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag || github.ref_name }}
          body_path: release-notes.md
          files: |
            release-artifacts/*
